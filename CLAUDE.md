# é¡¹ç›®å¼€å‘è§„èŒƒæ–‡æ¡£

## 1. æ¶æ„æ¨¡å¼

### 1.1 åˆ†å±‚æ¶æ„
æœ¬é¡¹ç›®é‡‡ç”¨ç»å…¸çš„ DDDï¼ˆé¢†åŸŸé©±åŠ¨è®¾è®¡ï¼‰åˆ†å±‚æ¶æ„ï¼š

```
api (æ¥å£å±‚)
â”œâ”€â”€ Resource: REST API æ§åˆ¶å™¨
â”œâ”€â”€ assembler: DTO/VO è½¬æ¢å™¨ (ä½¿ç”¨ MapStruct)
â””â”€â”€ config: API é…ç½®

domain (é¢†åŸŸå±‚)
â”œâ”€â”€ model: é¢†åŸŸå®ä½“
â”œâ”€â”€ service: é¢†åŸŸæœåŠ¡
â””â”€â”€ repository: ä»“å‚¨æ¥å£

infrastructure (åŸºç¡€è®¾æ–½å±‚)
â”œâ”€â”€ persistence: æŒä¹…åŒ–å®ç°
â”‚   â”œâ”€â”€ dao: MyBatis Mapper
â”‚   â””â”€â”€ *MyBatisRepository: Repository å®ç°
â””â”€â”€ message: æ¶ˆæ¯å®šä¹‰

dto: æ•°æ®ä¼ è¾“å¯¹è±¡
â”œâ”€â”€ *Command: å‘½ä»¤å¯¹è±¡ (æ–°å¢/ä¿®æ”¹)
â”œâ”€â”€ *Query: æŸ¥è¯¢å¯¹è±¡
â””â”€â”€ *DTO: æ•°æ®ä¼ è¾“å¯¹è±¡

vo: è§†å›¾å¯¹è±¡
security: å®‰å…¨è®¤è¯
enums: æšä¸¾å®šä¹‰
```

### 1.2 å„å±‚èŒè´£

#### Resource å±‚ï¼ˆæ¥å£å±‚ï¼‰
- **èŒè´£**ï¼šæ¥æ”¶ HTTP è¯·æ±‚ï¼Œå‚æ•°éªŒè¯ï¼Œè°ƒç”¨ Serviceï¼Œè¿”å›å“åº”
- **å‘½åè§„èŒƒ**ï¼š`*Resource.java`
- **æ ¸å¿ƒæ³¨è§£**ï¼š`@RestController`, `@RequestMapping("/api/v1")`
- **æƒé™æ§åˆ¶**ï¼šä½¿ç”¨ `@PreAuthorize("hasAuthority('system:xxx:xxx')")`

**ç¤ºä¾‹**ï¼š
```java
@RestController
@RequestMapping("/api/v1")
public class UserResource {
    private final UserMapper userMapper;
    private final UserService userService;

    @GetMapping("/users/{id}")
    @PreAuthorize("hasAuthority('system:user:list')")
    public User getUserById(@PathVariable BigInteger id) {
        return userService.findById(id);
    }
}
```

#### Service å±‚ï¼ˆé¢†åŸŸæœåŠ¡ï¼‰
- **èŒè´£**ï¼šä¸šåŠ¡é€»è¾‘å¤„ç†ï¼Œäº‹åŠ¡æ§åˆ¶ï¼Œè°ƒç”¨ Repository
- **å‘½åè§„èŒƒ**ï¼š`*Service.java`
- **æ ¸å¿ƒæ³¨è§£**ï¼š`@Service`, `@Transactional(rollbackFor = Exception.class)`
- **äº‹åŠ¡è§„èŒƒ**ï¼šæ‰€æœ‰æ¶‰åŠæ•°æ®ä¿®æ”¹çš„æ–¹æ³•å¿…é¡»æ·»åŠ äº‹åŠ¡æ³¨è§£

**ç¤ºä¾‹**ï¼š
```java
@Service
public class UserService {
    private final UserDao userDao;
    
    @Transactional(rollbackFor = Exception.class)
    public BigInteger create(User user) {
        // ä¸šåŠ¡é€»è¾‘
        userDao.insert(user);
        return user.getId();
    }
}
```

#### Repository å±‚ï¼ˆä»“å‚¨ï¼‰
- **æ¥å£å®šä¹‰**ï¼š`domain/repository/*Repository.java`
- **å®ç°ç±»**ï¼š`infrastructure/persistence/*MyBatisRepository.java`
- **æ ¸å¿ƒæ³¨è§£**ï¼š`@Repository`
- **èŒè´£**ï¼šå°è£…æ•°æ®è®¿é—®é€»è¾‘ï¼Œå±è”½æŒä¹…åŒ–æŠ€æœ¯ç»†èŠ‚

**ç¤ºä¾‹**ï¼š
```java
// æ¥å£
public interface UserRepository {
    User findById(BigInteger id);
    int create(User user);
}

// å®ç°
@Repository
public class UserMyBatisRepository implements UserRepository {
    private final UserDao userDao;
    
    @Override
    public User findById(BigInteger id) {
        return userDao.selectById(id);
    }
}
```

#### DAO å±‚ï¼ˆæ•°æ®è®¿é—®ï¼‰
- **å‘½åè§„èŒƒ**ï¼š`*Dao.java`
- **æ ¸å¿ƒæ³¨è§£**ï¼š`@Mapper`
- **æŠ€æœ¯æ ˆ**ï¼šMyBatis-Plus BaseMapper
- **è‡ªå®šä¹‰ SQL**ï¼šä½¿ç”¨ `@Select`, `@Update`, `@Delete` æ³¨è§£

**ç¤ºä¾‹**ï¼š
```java
@Mapper
public interface UserDao extends BaseMapper<User> {
    @Select("select * from sys_user where username = #{username} and status = #{status}")
    User findByUsernameAndStatus(String username, Boolean status);
}
```

---

## 2. æ•°æ®åº“è§„èŒƒ

### 2.1 è¡¨å‘½åè§„åˆ™
- **ç³»ç»Ÿè¡¨å‰ç¼€**ï¼š`sys_` (å¦‚ `sys_user`, `sys_role`, `sys_menu`)
- **ä¸šåŠ¡è¡¨å‰ç¼€**ï¼šæ ¹æ®æ¨¡å—å®šä¹‰ï¼ˆå¦‚é€šçŸ¥è¡¨ä½¿ç”¨ `notice`ï¼‰
- **å‘½åé£æ ¼**ï¼šè›‡å½¢å‘½åæ³• (snake_case)

### 2.2 ä¸»é”®è®¾è®¡
- **ä¸»é”®ç±»å‹**ï¼š`BigInteger`
- **ç”Ÿæˆç­–ç•¥**ï¼šè‡ªåŠ¨ç”Ÿæˆï¼ˆç»§æ‰¿ `AbstractAutoGeneratedIdAuditable`ï¼‰
- **å­—æ®µå**ï¼šç»Ÿä¸€ä½¿ç”¨ `id`

### 2.3 å¿…å¡«å­—æ®µï¼ˆå®¡è®¡å­—æ®µï¼‰

#### åŸºç¡€å®¡è®¡å­—æ®µ
æ‰€æœ‰å®ä½“ç±»ç»§æ‰¿ `AbstractAutoGeneratedIdAuditable<BigInteger>` æˆ– `AbstractAutoGeneratedIdLogicalDeletionAuditable<BigInteger, Boolean>`ï¼Œè‡ªåŠ¨åŒ…å«ï¼š

- `id`: ä¸»é”®
- `created_date` / `createdDate`: åˆ›å»ºæ—¶é—´
- `created_by` / `createdBy`: åˆ›å»ºäºº
- `last_modified_date` / `lastModifiedDate`: æœ€åä¿®æ”¹æ—¶é—´
- `last_modified_by` / `lastModifiedBy`: æœ€åä¿®æ”¹äºº

#### é€»è¾‘åˆ é™¤å­—æ®µ
- `deleted` / `is_deleted`: é€»è¾‘åˆ é™¤æ ‡è¯†ï¼ˆBoolean ç±»å‹ï¼Œ0-æœªåˆ é™¤ï¼Œ1-å·²åˆ é™¤ï¼‰

### 2.4 å­—æ®µç±»å‹æ˜ å°„

| Java ç±»å‹ | æ•°æ®åº“ç±»å‹ | ç¤ºä¾‹å­—æ®µ |
|----------|----------|---------|
| `BigInteger` | `BIGINT` | id, user_id |
| `String` | `VARCHAR` | username, name |
| `Boolean` | `TINYINT(1)` | status, deleted |
| `Map<String, Object>` | `JSON` | meta (èœå•å…ƒæ•°æ®) |
| `Enum` | `VARCHAR` | type (ä½¿ç”¨æšä¸¾å€¼) |

### 2.5 JSON å­—æ®µå¤„ç†
ä½¿ç”¨ MyBatis-Plus ç±»å‹å¤„ç†å™¨ï¼š

```java
@TableField(typeHandler = StringToMapHandler.class)
private Map<String, Object> meta;
```

### 2.6 å­—æ®µå­˜åœ¨æ€§æ§åˆ¶
éæ•°æ®åº“å­—æ®µä½¿ç”¨ `@TableField(exist = false)` æ ‡è¯†ï¼š

```java
@TableField(exist = false)
private Set<BigInteger> roleIds;
```

---

## 3. å¸¸ç”¨å·¥å…·æ ˆ

### 3.1 æ ¸å¿ƒä¾èµ–

#### ORM æ¡†æ¶
- **MyBatis-Plus**: æ•°æ®åº“è®¿é—®å¢å¼ºå·¥å…·
  - `BaseMapper`: åŸºç¡€ CRUD æ“ä½œ
  - `LambdaQueryWrapper`: ç±»å‹å®‰å…¨çš„æŸ¥è¯¢æ„é€ å™¨
  - `Page`: åˆ†é¡µå¯¹è±¡

**ä½¿ç”¨ç¤ºä¾‹**ï¼š
```java
// åˆ†é¡µæŸ¥è¯¢
Page<User> page = new Page<>(pageNo, pageSize);
userDao.selectPage(page, new LambdaQueryWrapper<User>()
    .eq(User::getStatus, true)
    .orderByDesc(User::getCreatedDate));
```

#### å¯¹è±¡è½¬æ¢
- **MapStruct**: å¯¹è±¡æ˜ å°„æ¡†æ¶
  - æ¥å£ç»§æ‰¿ `Converter<Source, Target>`
  - é…ç½®ç±»ï¼š`AuthCenterMapStructSpringConfig`

**ä½¿ç”¨ç¤ºä¾‹**ï¼š
```java
@Mapper(uses = AuthCenterMapStructSpringConfig.class)
public interface UserMapper extends Converter<UserCommand, User> {
    User convert(UserCommand userCommand);
    UserVo toUserVo(User user);
}
```

#### å®‰å…¨è®¤è¯
- **Spring Security**: æƒé™æ§åˆ¶
- **JWT (Auth0)**: Token ç”Ÿæˆä¸éªŒè¯
  - å¯†é’¥ï¼š`SecurityConstants.TOKEN_SECRET`
  - å‰ç¼€ï¼š`Bearer `

#### æŸ¥è¯¢æ„é€ å™¨
- **è‡ªå®šä¹‰ QueryWrapper è½¬æ¢å™¨**ï¼š`QueryWrapperConverter`
  - æ”¯æŒ `@RelationalQueryProperty` æ³¨è§£
  - è‡ªåŠ¨è½¬æ¢ Query å¯¹è±¡ä¸º MyBatis-Plus æŸ¥è¯¢æ¡ä»¶

**ä½¿ç”¨ç¤ºä¾‹**ï¼š
```java
public class UserQuery {
    @RelationalQueryProperty(type = Part.Type.STARTING_WITH)
    private String username;
    
    @RelationalQueryProperty(type = Part.Type.SIMPLE_PROPERTY)
    private Boolean status;
}

// Controller ä¸­ä½¿ç”¨
var queryWrapper = QueryWrapperConverter.convert(query, User.class);
userService.query(page, queryWrapper);
```

### 3.2 å·¥å…·ç±»

#### é›†åˆå·¥å…·
- **CollectionUtils**: é›†åˆè½¬æ¢å·¥å…·
  - `transformToList`: åˆ—è¡¨è½¬æ¢

#### æ ‘å½¢ç»“æ„
- **TreeFormatUtils**: æ ‘å½¢æ•°æ®å¤„ç†
  - `listToTree`: åˆ—è¡¨è½¬æ ‘å½¢ç»“æ„

---

## 3.3 å›½é™…åŒ–ï¼ˆi18nï¼‰

### 3.3.1 å›½é™…åŒ–é…ç½®

#### æ”¯æŒè¯­è¨€
- è‹±æ–‡ (en)
- ç®€ä½“ä¸­æ–‡ (zh_CN)

#### é…ç½®æ–‡ä»¶ä½ç½®
```
src/main/resources/messages/
â”œâ”€â”€ silence_auth_center_messages.properties          # é»˜è®¤è‹±æ–‡
â”œâ”€â”€ silence_auth_center_messages_en.properties       # è‹±æ–‡ï¼ˆå¤‡ä»½ï¼‰
â””â”€â”€ silence_auth_center_messages_zh_CN.properties    # ç®€ä½“ä¸­æ–‡
```

### 3.3.2 é”™è¯¯æ¶ˆæ¯å®šä¹‰

æ‰€æœ‰ç³»ç»Ÿé”™è¯¯æ¶ˆæ¯å®šä¹‰åœ¨ `AuthCenterMessages` æšä¸¾ä¸­ï¼Œå¹¶é€šè¿‡ properties æ–‡ä»¶å®ç°å›½é™…åŒ–ã€‚

**ç¤ºä¾‹**ï¼š
```java
public enum AuthCenterMessages implements ErrorCodedEnumMessageSourceResolvable {
    USER_NOT_EXIST(HttpStatus.BAD_REQUEST, 51),
    PASSWORD_NOT_CORRECT(HttpStatus.BAD_REQUEST, 52),
    USERNAME_ALREADY_EXIST(HttpStatus.BAD_REQUEST, 59),
    // ...
}
```

#### å¯¹åº”çš„å›½é™…åŒ–æ–‡ä»¶

**è‹±æ–‡** (silence_auth_center_messages.properties):
```properties
AuthCenterMessages.UserNotExist=User does not exist
AuthCenterMessages.PasswordNotCorrect=Password is incorrect
AuthCenterMessages.UsernameAlreadyExist=Username already exists
```

**ä¸­æ–‡** (silence_auth_center_messages_zh_CN.properties):
```properties
AuthCenterMessages.UserNotExist=ç”¨æˆ·ä¸å­˜åœ¨
AuthCenterMessages.PasswordNotCorrect=å¯†ç é”™è¯¯
AuthCenterMessages.UsernameAlreadyExist=ç”¨æˆ·åå·²å­˜åœ¨
```

### 3.3.3 ä½¿ç”¨è§„èŒƒ

#### âœ… å¿…é¡»éµå®ˆ

1. **æ‰€æœ‰ä¸šåŠ¡å¼‚å¸¸å¿…é¡»ä½¿ç”¨å›½é™…åŒ–æ¶ˆæ¯**
```java
// âœ… æ­£ç¡®åšæ³•
if (user == null || user.getDeleted()) {
    throw AuthCenterMessages.USER_NOT_EXIST.createException();
}

// âŒ é”™è¯¯åšæ³•
if (user == null || user.getDeleted()) {
    throw new BusinessException("ç”¨æˆ·ä¸å­˜åœ¨"); // ç¡¬ç¼–ç å­—ç¬¦ä¸²
}
```

2. **æ–°å¢å¼‚å¸¸å¸¸é‡å¿…é¡»åŒæ—¶æ›´æ–° properties æ–‡ä»¶**
```java
// 1. åœ¨ AuthCenterMessages.java ä¸­æ·»åŠ 
USERNAME_ALREADY_EXIST(HttpStatus.BAD_REQUEST, 59),

// 2. åœ¨ silence_auth_center_messages.properties ä¸­æ·»åŠ 
AuthCenterMessages.UsernameAlreadyExist=Username already exists

// 3. åœ¨ silence_auth_center_messages_zh_CN.properties ä¸­æ·»åŠ 
AuthCenterMessages.UsernameAlreadyExist=ç”¨æˆ·åå·²å­˜åœ¨
```

3. **ç‰¹å®šå‚æ•°çš„å¼‚å¸¸æ¶ˆæ¯ä½¿ç”¨æ–¹æ³•å‚æ•°**
```java
// âœ… æ­£ç¡®åšæ³• - å‚æ•°åœ¨è¿è¡Œæ—¶ä¼ é€’
throw AuthCenterMessages.USER_NOT_EXIST.createException(username);

// æ”¯æŒçš„å‚æ•°æ–¹æ³•
createException()                    // æ— å‚
createException(Object arg)          // å•å‚
createException(Object... args)      // å¤šå‚
```

4. **é”™è¯¯ä»£ç èŒƒå›´è§„åˆ’**

| æ¨¡å— | ä»£ç èŒƒå›´ | ç¤ºä¾‹ |
|------|---------|------|
| ç”¨æˆ·ç®¡ç† | 51-60 | USER_NOT_EXIST (51) |
| è§’è‰²ç®¡ç† | 61-70 | ROLE_NOT_EXIST (57) |
| èœå•ç®¡ç† | 71-80 | MENU_NOT_EXIST (54) |
| è®¤è¯æˆæƒ | 81-90 | TOKEN_INVALID (81) |
| å…¶ä»–ä¸šåŠ¡ | 91+ | æ ¹æ®éœ€è¦å®šä¹‰ |

#### âŒ ç¦æ­¢äº‹é¡¹

1. **ä¸è¦ç¡¬ç¼–ç ä¸­æ–‡æˆ–è‹±æ–‡å­—ç¬¦ä¸²**
```java
// âŒ é”™è¯¯
throw new BusinessException("ç”¨æˆ·ä¸å­˜åœ¨");
throw new BusinessException("User not exist");

// âœ… æ­£ç¡®
throw AuthCenterMessages.USER_NOT_EXIST.createException();
```

2. **ä¸è¦æ··åˆä½¿ç”¨å›½é™…åŒ–å’Œç¡¬ç¼–ç **
```java
// âŒ é”™è¯¯æ··åˆ
if (error) {
    throw AuthCenterMessages.USER_NOT_EXIST.createException();
}
if (other) {
    throw new BusinessException("å…¶ä»–é”™è¯¯"); // è¿™æ˜¯ç¡¬ç¼–ç 
}

// âœ… æ­£ç¡® - å…¨éƒ¨ä½¿ç”¨å›½é™…åŒ–
if (error) {
    throw AuthCenterMessages.USER_NOT_EXIST.createException();
}
if (other) {
    throw AuthCenterMessages.OTHER_ERROR.createException();
}
```

3. **ä¸è¦åœ¨ä»£ç ä¸­æ‹¼æ¥é”™è¯¯æ¶ˆæ¯**
```java
// âŒ é”™è¯¯
String msg = "User " + username + " not found";
throw new BusinessException(msg);

// âœ… æ­£ç¡®
throw AuthCenterMessages.USER_NOT_EXIST.createException(username);
```

### 3.3.4 i18n æ¶ˆæ¯æ–‡ä»¶ç»´æŠ¤æ¸…å•

- [ ] æ–°å¢å¼‚å¸¸å¸¸é‡æ—¶åŒæ—¶æ›´æ–°ä¸‰ä¸ª properties æ–‡ä»¶
- [ ] è‹±æ–‡å’Œä¸­æ–‡ç¿»è¯‘ä¿æŒä¸€è‡´çš„é€»è¾‘å«ä¹‰
- [ ] é”™è¯¯ä»£ç èŒƒå›´ä¸é‡å¤
- [ ] ä¿æŒ properties æ–‡ä»¶çš„ç¼–ç ä¸º UTF-8 (å«ä¸­æ–‡)
- [ ] å®šæœŸå®¡æŸ¥æœªä½¿ç”¨çš„æ¶ˆæ¯å¸¸é‡

**ä½¿ç”¨ç¤ºä¾‹**ï¼š
```java
var menuDtos = menus.stream()
    .map(menuMapper::convertToDto)
    .collect(Collectors.toList());

Map<BigInteger, List<MenuDto>> parentMap = menuDtos.stream()
    .collect(Collectors.groupingBy(MenuDto::getParentId));

menuDtos.forEach(menu -> 
    menu.setChildren(parentMap.getOrDefault(menu.getId(), new ArrayList<>())));
```

---

## 4. å¼€å‘çº¢çº¿

### 4.1 æ•°æ®åº“æ“ä½œ

#### âŒ ç¦æ­¢äº‹é¡¹

1. **ç¦æ­¢åœ¨å¾ªç¯ä¸­æŸ¥è¯¢æ•°æ®åº“**
```java
// âŒ é”™è¯¯ç¤ºä¾‹
for (BigInteger userId : userIds) {
    User user = userDao.selectById(userId); // æ¯æ¬¡å¾ªç¯éƒ½æŸ¥åº“
}

// âœ… æ­£ç¡®ç¤ºä¾‹
List<User> users = userDao.selectBatchIds(userIds); // æ‰¹é‡æŸ¥è¯¢
```

2. **ç¦æ­¢ä¸åŠ åˆ†é¡µæŸ¥è¯¢å¤§é‡æ•°æ®**
```java
// âŒ é”™è¯¯ç¤ºä¾‹
List<User> users = userDao.selectList(null); // æŸ¥è¯¢æ‰€æœ‰æ•°æ®

// âœ… æ­£ç¡®ç¤ºä¾‹
Page<User> page = new Page<>(pageNo, pageSize);
userDao.selectPage(page, queryWrapper);
```

3. **ç¦æ­¢ä½¿ç”¨ `select *`ï¼ˆMyBatis-Plus é»˜è®¤æŸ¥è¯¢æ‰€æœ‰å­—æ®µï¼Œéœ€æ³¨æ„ï¼‰**
```java
// å¦‚éœ€æŒ‡å®šå­—æ®µï¼Œä½¿ç”¨ LambdaQueryWrapper
new LambdaQueryWrapper<User>()
    .select(User::getId, User::getUsername);
```

#### âœ… å¿…é¡»éµå®ˆ

1. **æ‰€æœ‰ä¿®æ”¹æ“ä½œå¿…é¡»æ·»åŠ äº‹åŠ¡æ³¨è§£**
```java
@Transactional(rollbackFor = Exception.class)
public void update(User user) {
    // æ›´æ–°é€»è¾‘
}
```

2. **å…³è”æ•°æ®ä¿®æ”¹å¿…é¡»åœ¨åŒä¸€äº‹åŠ¡ä¸­**
```java
@Transactional(rollbackFor = Exception.class)
public void update(User user) {
    userDao.updateById(user);
    userRoleDao.delete(new LambdaQueryWrapper<UserRole>()
        .eq(UserRole::getUserId, user.getId()));
    // é‡æ–°åˆ†é…è§’è‰²
    assignUserRoles(user.getId(), user.getRoleIds());
}
```

### 4.2 å¼‚å¸¸å¤„ç†

#### âŒ ç¦æ­¢äº‹é¡¹

1. **ç¦æ­¢åæ‰å¼‚å¸¸**
```java
// âŒ é”™è¯¯ç¤ºä¾‹
try {
    // ä¸šåŠ¡é€»è¾‘
} catch (Exception e) {
    // ä»€ä¹ˆéƒ½ä¸åš
}

// âœ… æ­£ç¡®ç¤ºä¾‹
try {
    // ä¸šåŠ¡é€»è¾‘
} catch (Exception e) {
    log.error("ä¸šåŠ¡å¤„ç†å¤±è´¥", e);
    throw new RuntimeException("ä¸šåŠ¡å¤„ç†å¤±è´¥", e);
}
```

2. **ç¦æ­¢æ•è·å¼‚å¸¸åä»…æ‰“å°æ—¥å¿—ä¸æŠ›å‡º**
```java
// âŒ é”™è¯¯ç¤ºä¾‹
try {
    userDao.insert(user);
} catch (Exception e) {
    log.error("ç”¨æˆ·åˆ›å»ºå¤±è´¥", e);
    // æ²¡æœ‰æŠ›å‡ºå¼‚å¸¸ï¼Œè°ƒç”¨æ–¹æ— æ³•æ„ŸçŸ¥
}

// âœ… æ­£ç¡®ç¤ºä¾‹
try {
    userDao.insert(user);
} catch (Exception e) {
    log.error("ç”¨æˆ·åˆ›å»ºå¤±è´¥", e);
    throw AuthCenterMessages.USER_CREATE_FAILED.createException("ç”¨æˆ·åˆ›å»ºå¤±è´¥", e);
}
```

#### âœ… å¿…é¡»éµå®ˆ

1. **ä½¿ç”¨ç»Ÿä¸€çš„ä¸šåŠ¡å¼‚å¸¸**
```java
if (existingRole == null || existingRole.getDeleted()) {
    throw AuthCenterMessages.ROLE_NOT_EXIST.createException("è§’è‰²ä¸å­˜åœ¨");
}
```

2. **äº‹åŠ¡æ–¹æ³•å¿…é¡»å£°æ˜ `rollbackFor = Exception.class`**
```java
@Transactional(rollbackFor = Exception.class)
public void delete(BigInteger id) {
    // ä¸šåŠ¡é€»è¾‘
}
```

### 4.3 ä»£ç è§„èŒƒ

#### âŒ ç¦æ­¢äº‹é¡¹

1. **ç¦æ­¢ç¡¬ç¼–ç å­—ç¬¦ä¸²**
```java
// âŒ é”™è¯¯ç¤ºä¾‹
if ("admin".equals(username)) { }

// âœ… æ­£ç¡®ç¤ºä¾‹
if (SecurityConstants.ADMIN_USERNAME.equals(username)) { }
```

2. **ç¦æ­¢ä½¿ç”¨é­”æ³•æ•°å­—**
```java
// âŒ é”™è¯¯ç¤ºä¾‹
user.setStatus(1);

// âœ… æ­£ç¡®ç¤ºä¾‹
user.setStatus(true); // æˆ–ä½¿ç”¨æšä¸¾
```

3. **ç¦æ­¢åœ¨ Service å±‚ç›´æ¥æ³¨å…¥ DAO**
```java
// âŒ é”™è¯¯ç¤ºä¾‹ï¼ˆService å±‚ç›´æ¥æ³¨å…¥ DAOï¼‰
@Service
public class UserService {
    private final UserDao userDao; // åº”è¯¥æ³¨å…¥ Repository
}

// âœ… æ­£ç¡®ç¤ºä¾‹
@Service
public class UserService {
    private final UserRepository userRepository;
}
```

#### âœ… å¿…é¡»éµå®ˆ

1. **å®ä½“ç±»å¿…é¡»ç»§æ‰¿å®¡è®¡åŸºç±»**
```java
public class User extends AbstractAutoGeneratedIdLogicalDeletionAuditable<BigInteger, Boolean> {
    // å­—æ®µå®šä¹‰
}
```

2. **DTO è½¬æ¢å¿…é¡»ä½¿ç”¨ MapStruct**
```java
@Mapper(uses = AuthCenterMapStructSpringConfig.class)
public interface UserMapper extends Converter<UserCommand, User> {
    User convert(UserCommand userCommand);
}
```

3. **æŸ¥è¯¢å¯¹è±¡å¿…é¡»ä½¿ç”¨ `@RelationalQueryProperty` æ³¨è§£**
```java
public class UserQuery {
    @RelationalQueryProperty(type = Part.Type.STARTING_WITH)
    private String username;
}
```

4. **é€»è¾‘åˆ é™¤å¿…é¡»ä½¿ç”¨æ ‡å¿—ä½ï¼Œç¦æ­¢ç‰©ç†åˆ é™¤**
```java
@Transactional(rollbackFor = Exception.class)
public void delete(BigInteger id) {
    User user = userDao.selectById(id);
    user.setDeleted(true);
    userDao.updateById(user);
}
```

### 4.4 å®‰å…¨è§„èŒƒ

#### âŒ ç¦æ­¢äº‹é¡¹

1. **ç¦æ­¢æ˜æ–‡å­˜å‚¨å¯†ç **
```java
// å¿…é¡»åŠ å¯†å­˜å‚¨ï¼Œæœ¬é¡¹ç›®ç¤ºä¾‹ä¸­ä½¿ç”¨é»˜è®¤å¯†ç éœ€æ³¨æ„ç”Ÿäº§ç¯å¢ƒå®‰å…¨
user.setPassword(passwordEncoder.encode("123456"));
```

2. **ç¦æ­¢åœ¨æ—¥å¿—ä¸­æ‰“å°æ•æ„Ÿä¿¡æ¯**
```java
// âŒ é”™è¯¯ç¤ºä¾‹
log.info("ç”¨æˆ·ç™»å½•ï¼š{}", user); // user å¯¹è±¡åŒ…å«å¯†ç 

// âœ… æ­£ç¡®ç¤ºä¾‹
log.info("ç”¨æˆ·ç™»å½•ï¼šusername={}", user.getUsername());
```

3. **ç¦æ­¢ç›´æ¥è¿”å›å®ä½“ç±»**
```java
// âŒ é”™è¯¯ç¤ºä¾‹
@GetMapping("/users/{id}")
public User getUser(@PathVariable BigInteger id) {
    return userService.findById(id);
}

// âœ… æ­£ç¡®ç¤ºä¾‹
@GetMapping("/users/{id}")
public UserVo getUser(@PathVariable BigInteger id) {
    User user = userService.findById(id);
    return userMapper.toUserVo(user);
}
```

#### âœ… å¿…é¡»éµå®ˆ

1. **æ‰€æœ‰æ¥å£å¿…é¡»æ·»åŠ æƒé™æ§åˆ¶**
```java
@PreAuthorize("hasAuthority('system:user:list')")
@GetMapping("/users/{id}")
public User getUserById(@PathVariable BigInteger id) {
    return userService.findById(id);
}
```

2. **Token éªŒè¯å¿…é¡»ä½¿ç”¨ç»Ÿä¸€çš„è®¤è¯æœºåˆ¶**
```java
// ä½¿ç”¨ SilenceHallServerTokenAuthority è¿›è¡Œ Token ç­¾å‘å’ŒéªŒè¯
var token = silenceHallServerTokenAuthority.issueToken(principal);
```

---

## 5. æœ€ä½³å®è·µ

### 5.1 åˆ†é¡µæŸ¥è¯¢æ¨¡æ¿
```java
@GetMapping(value = "/users", params = {"pageNo", "pageSize"})
public Page<User> query(Page<User> page, UserQuery query) {
    var queryWrapper = QueryWrapperConverter.convert(query, User.class);
    return userService.query(page, queryWrapper);
}
```

### 5.2 æ‰¹é‡æ“ä½œæ¨¡æ¿
```java
@Transactional(rollbackFor = Exception.class)
private void assignUserRoles(BigInteger userId, List<BigInteger> roleIds) {
    List<UserRole> userRoles = roleIds.stream()
        .map(roleId -> {
            UserRole userRole = new UserRole();
            userRole.setUserId(userId);
            userRole.setRoleId(roleId);
            return userRole;
        }).collect(Collectors.toList());
    userRoleDao.insertBatchSomeColumn(userRoles);
}
```

### 5.3 æ ‘å½¢ç»“æ„æ„å»ºæ¨¡æ¿
```java
private List<MenuDto> buildMenuTree(List<Menu> menus) {
    var menuMapper = Mappers.getMapper(MenuMapper.class);
    var menuDtos = menus.stream()
        .map(menuMapper::convertToDto)
        .collect(Collectors.toList());
    
    Map<BigInteger, List<MenuDto>> parentMap = menuDtos.stream()
        .collect(Collectors.groupingBy(MenuDto::getParentId));
    
    menuDtos.forEach(menu -> 
        menu.setChildren(parentMap.getOrDefault(menu.getId(), new ArrayList<>())));
    
    return parentMap.getOrDefault(BigInteger.ZERO, new ArrayList<>());
}
```

### 5.4 å‚æ•°æ ¡éªŒæ¨¡æ¿
```java
@Transactional(rollbackFor = Exception.class)
public void update(User user) {
    // 1. æ£€æŸ¥å®ä½“æ˜¯å¦å­˜åœ¨
    User existingUser = userDao.selectById(user.getId());
    if (existingUser == null || existingUser.getDeleted()) {
        throw AuthCenterMessages.USER_NOT_EXIST.createException("ç”¨æˆ·ä¸å­˜åœ¨");
    }
    
    // 2. ä¸šåŠ¡è§„åˆ™æ ¡éªŒ
    if (!existingUser.getUsername().equals(user.getUsername()) 
        && isUsernameExists(user.getUsername())) {
        throw AuthCenterMessages.USERNAME_ALREADY_EXIST.createException("ç”¨æˆ·åå·²å­˜åœ¨");
    }
    
    // 3. æ‰§è¡Œæ›´æ–°
    userDao.updateById(user);
}
```

---

## 6. é¡¹ç›®ç»“æ„ç¤ºä¾‹

```
silence-auth-center/
â”œâ”€â”€ silence-auth-center-client/          # å®¢æˆ·ç«¯æ¨¡å—
â”œâ”€â”€ silence-auth-center-client-permission/ # å®¢æˆ·ç«¯æƒé™æ¨¡å—
â”œâ”€â”€ silence-auth-center-console/         # æ§åˆ¶å°æ¨¡å—ï¼ˆä¸»æ¨¡å—ï¼‰
â”‚   â””â”€â”€ src/main/java/com/old/silence/auth/center/
â”‚       â”œâ”€â”€ api/                         # æ¥å£å±‚
â”‚       â”‚   â”œâ”€â”€ assembler/              # DTO è½¬æ¢å™¨
â”‚       â”‚   â”œâ”€â”€ config/                 # é…ç½®ç±»
â”‚       â”‚   â”œâ”€â”€ UserResource.java
â”‚       â”‚   â”œâ”€â”€ RoleResource.java
â”‚       â”‚   â””â”€â”€ MenuResource.java
â”‚       â”œâ”€â”€ domain/                      # é¢†åŸŸå±‚
â”‚       â”‚   â”œâ”€â”€ model/                  # é¢†åŸŸå®ä½“
â”‚       â”‚   â”œâ”€â”€ repository/             # ä»“å‚¨æ¥å£
â”‚       â”‚   â””â”€â”€ service/                # é¢†åŸŸæœåŠ¡
â”‚       â”œâ”€â”€ infrastructure/              # åŸºç¡€è®¾æ–½å±‚
â”‚       â”‚   â”œâ”€â”€ persistence/            # æŒä¹…åŒ–
â”‚       â”‚   â”‚   â”œâ”€â”€ dao/               # MyBatis Mapper
â”‚       â”‚   â”‚   â””â”€â”€ *MyBatisRepository.java
â”‚       â”‚   â””â”€â”€ message/                # æ¶ˆæ¯å®šä¹‰
â”‚       â”œâ”€â”€ dto/                         # æ•°æ®ä¼ è¾“å¯¹è±¡
â”‚       â”œâ”€â”€ vo/                          # è§†å›¾å¯¹è±¡
â”‚       â”œâ”€â”€ security/                    # å®‰å…¨è®¤è¯
â”‚       â””â”€â”€ enums/                       # æšä¸¾å®šä¹‰
â”œâ”€â”€ silence-auth-center-domain-enums/    # é¢†åŸŸæšä¸¾æ¨¡å—
â””â”€â”€ silence-auth-center-security/        # å®‰å…¨æ¨¡å—
```

---

## 7. æ³¨æ„äº‹é¡¹

1. **æ‰€æœ‰æ•°æ®åº“å®ä½“ç±»å¿…é¡»ç»§æ‰¿å®¡è®¡åŸºç±»**ï¼Œè‡ªåŠ¨å¡«å……åˆ›å»ºæ—¶é—´ã€ä¿®æ”¹æ—¶é—´ç­‰å­—æ®µ
2. **é€»è¾‘åˆ é™¤ä¼˜å…ˆäºç‰©ç†åˆ é™¤**ï¼Œä¿è¯æ•°æ®å¯è¿½æº¯
3. **äº‹åŠ¡è¾¹ç•Œæ¸…æ™°**ï¼ŒService å±‚æ–¹æ³•ä¸ºäº‹åŠ¡è¾¹ç•Œ
4. **æ¥å£è¿”å›å€¼ä½¿ç”¨ VO å¯¹è±¡**ï¼Œé¿å…ç›´æ¥æš´éœ²å®ä½“ç±»
5. **æŸ¥è¯¢æ¡ä»¶ä½¿ç”¨ Query å¯¹è±¡**ï¼Œé…åˆ `@RelationalQueryProperty` æ³¨è§£è‡ªåŠ¨æ„å»ºæŸ¥è¯¢
6. **æƒé™æ§åˆ¶ç»†ç²’åº¦åˆ°æŒ‰é’®çº§åˆ«**ï¼Œä½¿ç”¨ `system:æ¨¡å—:æ“ä½œ` æ ¼å¼
7. **å¯†ç ç­‰æ•æ„Ÿä¿¡æ¯å¿…é¡»åŠ å¯†å­˜å‚¨**
8. **æ‰€æœ‰å¤–éƒ¨è¾“å…¥å¿…é¡»è¿›è¡Œæ ¡éªŒ**

---

## 8. å‚è€ƒé“¾æ¥

- [MyBatis-Plus å®˜æ–¹æ–‡æ¡£](https://baomidou.com/)
- [MapStruct å®˜æ–¹æ–‡æ¡£](https://mapstruct.org/)
- [Spring Security å®˜æ–¹æ–‡æ¡£](https://spring.io/projects/spring-security)
- [JWT å®˜æ–¹æ–‡æ¡£](https://jwt.io/)

---

## é™„å½•ï¼šé¡¹ç›®å½“å‰ä»£ç é—®é¢˜åˆ†æ

### A. é«˜ä¼˜å…ˆçº§é—®é¢˜ä¿®å¤å®Œæˆ âœ…

æ‰€æœ‰ 5 ä¸ªé«˜ä¼˜å…ˆçº§é—®é¢˜å·²æˆåŠŸä¿®å¤å¹¶ç¼–è¯‘é€šè¿‡ã€‚

#### âœ… å·²ä¿®å¤é—®é¢˜

1. **å¼‚å¸¸å¤„ç†ä¸¢å¤±å †æ ˆ** [å·²ä¿®å¤]
   - **æ–‡ä»¶**: [api/CaptchaResource.java](silence-auth-center-console/src/main/java/com/old/silence/auth/center/api/CaptchaResource.java#L82-L86)
   - **ä¿®æ”¹**:
   ```java
   // âœ… ä¿®å¤å
   catch (IOException e) {
       throw new IOException("éªŒè¯ç å›¾ç‰‡ç”Ÿæˆå¤±è´¥", e); // ä¿ç•™åŸå§‹å¼‚å¸¸é“¾
   }
   ```
   - **çŠ¶æ€**: âœ… å·²å®Œæˆ

2. **èœå•åˆ é™¤é€»è¾‘é”™è¯¯** [å·²ä¿®å¤]
   - **æ–‡ä»¶**: [domain/service/MenuService.java](silence-auth-center-console/src/main/java/com/old/silence/auth/center/domain/service/MenuService.java#L98-L114)
   - **ä¿®æ”¹**: è°ƒæ•´åˆ é™¤é€»è¾‘é¡ºåºï¼Œå…ˆæ£€æŸ¥å†åˆ é™¤
   ```java
   // âœ… ä¿®å¤å
   @Transactional(rollbackFor = Exception.class)
   public void delete(BigInteger id) {
       // 1. å…ˆæ£€æŸ¥èœå•æ˜¯å¦å­˜åœ¨
       Menu menu = menuRepository.findById(id);
       if (menu == null || menu.getDeleted()) {
           throw AuthCenterMessages.MENU_NOT_EXIST.createException();
       }
       
       // 2. æ£€æŸ¥æ˜¯å¦æœ‰å­èœå•
       boolean hasChildren = menuRepository.existsByParentIdAndDeleted(id, false);
       if (hasChildren) {
           throw AuthCenterMessages.SUB_MENU_EXIST.createException();
       }
       
       // 3. æ‰§è¡Œé€»è¾‘åˆ é™¤
       menu.setDeleted(true);
       menuRepository.update(menu);
   }
   ```
   - **çŠ¶æ€**: âœ… å·²å®Œæˆ

3. **ç›´æ¥è¿”å›å®ä½“ç±»** [å·²ä¿®å¤]
   - **æ–‡ä»¶**: [api/UserResource.java](silence-auth-center-console/src/main/java/com/old/silence/auth/center/api/UserResource.java#L57-L62)
   - **ä¿®æ”¹**: è¿”å›å€¼ä» `User` æ”¹ä¸º `UserVo`
   ```java
   // âœ… ä¿®å¤å
   @GetMapping("/users/{id}")
   @PreAuthorize("@perm.hasAuthority('system:user:list')")
   public UserVo getUserById(@PathVariable BigInteger id) {
       User user = userService.findById(id);
       return userMapper.toUserVo(user); // ä½¿ç”¨ VO å¯¹è±¡
   }
   ```
   - **çŠ¶æ€**: âœ… å·²å®Œæˆ

4. **å¯†ç ä¿®æ”¹æ— æ£€æŸ¥** [å·²ä¿®å¤]
   - **æ–‡ä»¶**: [domain/service/UserService.java](silence-auth-center-console/src/main/java/com/old/silence/auth/center/domain/service/UserService.java#L142-L160)
   - **ä¿®æ”¹**: æ·»åŠ ç”¨æˆ·å­˜åœ¨æ€§éªŒè¯
   ```java
   // âœ… ä¿®å¤å
   public void resetPassword(BigInteger id, String password) {
       // 1. æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å­˜åœ¨
       User existingUser = userRepository.findById(id);
       if (existingUser == null || existingUser.getDeleted()) {
           throw AuthCenterMessages.USER_NOT_EXIST.createException();
       }
       
       // 2. éªŒè¯å¯†ç å¼ºåº¦
       validatePasswordStrength(password);
       
       // 3. æ›´æ–°å¯†ç 
       // ... æ›´æ–°é€»è¾‘
   }
   ```
   - **çŠ¶æ€**: âœ… å·²å®Œæˆ

5. **åˆ›å»ºç”¨æˆ·æ— é‡å¤æ£€æŸ¥** [å·²ä¿®å¤]
   - **æ–‡ä»¶**: [domain/service/UserService.java](silence-auth-center-console/src/main/java/com/old/silence/auth/center/domain/service/UserService.java#L64-L83)
   - **ä¿®æ”¹**: æ·»åŠ ç”¨æˆ·åå­˜åœ¨æ€§æ£€æŸ¥
   ```java
   // âœ… ä¿®å¤å
   @Transactional(rollbackFor = Exception.class)
   public BigInteger create(User user) {
       // 1. æ£€æŸ¥ç”¨æˆ·åæ˜¯å¦å·²å­˜åœ¨
       if (existsByUsername(user.getUsername())) {
           throw AuthCenterMessages.USERNAME_ALREADY_EXIST.createException();
       }
       
       // 2. éªŒè¯å¯†ç å¼ºåº¦
       validatePasswordStrength(user.getPassword());
       
       // 3. åŠ å¯†å¯†ç å¹¶åˆ›å»º
       String encodedPassword = passwordUtil.encodePassword(user.getPassword());
       user.setPassword(encodedPassword);
       userRepository.create(user);
       
       // 4. åˆ†é…è§’è‰²
       if (user.getRoleIds() != null && !user.getRoleIds().isEmpty()) {
           assignUserRoles(user.getId(), user.getRoleIds());
       }
       
       return user.getId();
   }
   ```
   - **æ–°å¢å¸¸é‡**: [AuthCenterMessages.java](silence-auth-center-console/src/main/java/com/old/silence/auth/center/infrastructure/message/AuthCenterMessages.java#L11)
   ```java
   USERNAME_ALREADY_EXIST(HttpStatus.BAD_REQUEST, 59), // "ç”¨æˆ·åå·²å­˜åœ¨"
   ```
   - **çŠ¶æ€**: âœ… å·²å®Œæˆ

---

### B. ç¼–è¯‘éªŒè¯

æ‰€æœ‰é«˜ä¼˜å…ˆçº§ä¿®å¤å·²é€šè¿‡ Maven ç¼–è¯‘éªŒè¯ï¼š

```
[INFO] silence-auth-center ................................ SUCCESS
[INFO] silence-auth-center-security ....................... SUCCESS
[INFO] silence-auth-center-client ......................... SUCCESS
[INFO] silence-auth-center-domain-enums ................... SUCCESS
[INFO] silence-auth-center-console ........................ SUCCESS
[INFO] silence-auth-center-client-permission .............. SUCCESS
[INFO] 
[INFO] BUILD SUCCESS
```

---

### C. ä¿®å¤å¯¹æ¯”æ€»è¡¨ï¼ˆå·²å¼ƒç”¨ - è§ G èŠ‚å®Œæ•´è¡¨æ ¼ï¼‰

| é—®é¢˜ | æ–‡ä»¶ | ä¿®å¤å†…å®¹ | çŠ¶æ€ |
|------|------|---------|------|
| å¼‚å¸¸å¤„ç†ä¸¢å¤±å †æ ˆ | CaptchaResource | ä¿ç•™åŸå§‹å¼‚å¸¸é“¾ | âœ… |
| èœå•åˆ é™¤é€»è¾‘é”™è¯¯ | MenuService | è°ƒæ•´æ£€æŸ¥é¡ºåº | âœ… |
| ç›´æ¥è¿”å›å®ä½“ç±» | UserResource | æ”¹ä¸ºè¿”å› VO | âœ… |
| å¯†ç ä¿®æ”¹æ— æ£€æŸ¥ | UserService | æ·»åŠ å­˜åœ¨æ€§æ£€æŸ¥ | âœ… |
| åˆ›å»ºç”¨æˆ·æ— é‡å¤æ£€æŸ¥ | UserService | æ·»åŠ ç”¨æˆ·åæ£€æŸ¥ | âœ… |
| å›½é™…åŒ–ç¿»è¯‘ç¼ºå¤± | i18n properties | æ·»åŠ æ–°é”™è¯¯å¸¸é‡ç¿»è¯‘ | âœ… |

---

### H. å›½é™…åŒ–é€‚é…è¯¦æƒ… âœ…

#### æ–°å¢å¸¸é‡å›½é™…åŒ–ç¿»è¯‘

**æ–‡ä»¶**:
- [silence_auth_center_messages.properties](silence-auth-center-console/src/main/resources/messages/silence_auth_center_messages.properties)
- [silence_auth_center_messages_zh_CN.properties](silence-auth-center-console/src/main/resources/messages/silence_auth_center_messages_zh_CN.properties)

**ä¿®æ”¹å†…å®¹**:
```properties
# è‹±æ–‡
AuthCenterMessages.UsernameAlreadyExist=Username already exists

# ä¸­æ–‡
AuthCenterMessages.UsernameAlreadyExist=ç”¨æˆ·åå·²å­˜åœ¨
```

#### æ”¯æŒè¯­è¨€
- ğŸ‡¬ğŸ‡§ English (en)
- ğŸ‡¨ğŸ‡³ ç®€ä½“ä¸­æ–‡ (zh_CN)

---

### D. ä¸­ä¼˜å…ˆçº§é—®é¢˜ä¿®å¤å®Œæˆ âœ…

æ‰€æœ‰ 3 ä¸ªä¸­ä¼˜å…ˆçº§é—®é¢˜å·²æˆåŠŸä¿®å¤å¹¶ç¼–è¯‘é€šè¿‡ï¼ˆ2026-02-09ï¼‰ã€‚

#### âœ… å·²ä¿®å¤é—®é¢˜

1. **æ—¥æœŸæ—¶é—´é‡å¤è®¾ç½®** [å·²ä¿®å¤]
   - **æ–‡ä»¶**: [domain/service/RoleService.java](silence-auth-center-console/src/main/java/com/old/silence/auth/center/domain/service/RoleService.java#L148-L166)
   - **ä¿®æ”¹**: ç§»é™¤ `Instant` å¯¼å…¥å’Œæ‰‹åŠ¨è®¾ç½®çš„ `createdDate`/`updatedDate`
   ```java
   // âŒ ä¿®å¤å‰
   roleMenus.forEach(roleMenu -> {
       roleMenu.setCreatedDate(Instant.now());
       roleMenu.setUpdatedDate(Instant.now());
   });
   
   // âœ… ä¿®å¤å - ä¾èµ–æ¡†æ¶è‡ªåŠ¨å®¡è®¡å­—æ®µå¡«å……
   var roleMenus = menuIds.stream()
       .map(menuId -> new RoleMenu(id, menuId))
       .collect(Collectors.toList());
   roleMenuRepository.bulkInsert(roleMenus);
   ```
   - **çŠ¶æ€**: âœ… å·²å®Œæˆ

2. **ç”¨æˆ·æ›´æ–°å¯†ç å¤„ç†ä¸å½“** [å·²ä¿®å¤]
   - **æ–‡ä»¶**: [domain/service/UserService.java](silence-auth-center-console/src/main/java/com/old/silence/auth/center/domain/service/UserService.java#L125-L151)
   - **ä¿®æ”¹**: æœ‰æ¡ä»¶åœ°éªŒè¯å’Œç¼–ç å¯†ç 
   ```java
   // âœ… ä¿®å¤å
   @Transactional(rollbackFor = Exception.class)
   public void update(User user) {
       logger.info("æ›´æ–°ç”¨æˆ·ä¿¡æ¯ï¼šid={}, username={}", user.getId(), user.getUsername());
       
       User existingUser = userRepository.findById(user.getId());
       
       // å¤„ç†å¯†ç æ›´æ–°
       if (user.getPassword() != null && !user.getPassword().isEmpty()) {
           // å¦‚æœæä¾›äº†æ–°å¯†ç ï¼Œè¿›è¡ŒéªŒè¯å’Œç¼–ç 
           logger.debug("ç”¨æˆ·æ›´æ–°åŒ…å«å¯†ç ä¿®æ”¹ï¼šid={}", user.getId());
           validatePasswordStrength(user.getPassword());
           String encodedPassword = passwordUtil.encodePassword(user.getPassword());
           user.setPassword(encodedPassword);
       } else {
           // å¦‚æœæ²¡æœ‰æä¾›æ–°å¯†ç ï¼Œä¿æŒåŸå¯†ç ä¸å˜
           user.setPassword(existingUser.getPassword());
       }
       
       userRepository.update(user);
       
       if (user.getRoleIds() != null) {
           assignUserRoles(user.getId(), user.getRoleIds());
       }
       
       logger.info("ç”¨æˆ·ä¿¡æ¯æ›´æ–°æˆåŠŸï¼šid={}", user.getId());
   }
   ```
   - **çŠ¶æ€**: âœ… å·²å®Œæˆ

3. **ç¼ºå°‘å…³é”®æ“ä½œæ—¥å¿—** [å·²ä¿®å¤]
   - **æ–‡ä»¶**: 
     - [RoleService.java](silence-auth-center-console/src/main/java/com/old/silence/auth/center/domain/service/RoleService.java)
     - [MenuService.java](silence-auth-center-console/src/main/java/com/old/silence/auth/center/domain/service/MenuService.java)
     - [UserService.java](silence-auth-center-console/src/main/java/com/old/silence/auth/center/domain/service/UserService.java)
   - **ä¿®æ”¹**: æ·»åŠ  SLF4J Logger å¹¶è®°å½•å…³é”®æ“ä½œ
   ```java
   // âœ… æ‰€æœ‰ Service ç±»æ·»åŠ äº† Logger
   private static final Logger logger = LoggerFactory.getLogger(XxxService.class);
   
   // âœ… æ“ä½œç¤ºä¾‹
   logger.info("åˆ›å»ºæ–°ç”¨æˆ·ï¼šusername={}", user.getUsername());
   logger.warn("ç”¨æˆ·åˆ›å»ºå¤±è´¥ï¼Œç”¨æˆ·åå·²å­˜åœ¨ï¼šusername={}", user.getUsername());
   logger.debug("ç”¨æˆ·æ›´æ–°åŒ…å«å¯†ç ä¿®æ”¹ï¼šid={}", user.getId());
   logger.info("ç”¨æˆ·åˆ›å»ºæˆåŠŸï¼šid={}, username={}", user.getId(), user.getUsername());
   ```
   - **æ—¥å¿—çº§åˆ«è§„èŒƒ**:
     - `info`: æ­£å¸¸ä¸šåŠ¡æ“ä½œï¼ˆåˆ›å»ºã€æ›´æ–°ã€åˆ é™¤ï¼‰çš„å¼€å§‹å’ŒæˆåŠŸ
     - `warn`: ä¸šåŠ¡éªŒè¯å¤±è´¥ï¼ˆç”¨æˆ·åé‡å¤ã€èœå•ä¸å­˜åœ¨ç­‰ï¼‰
     - `debug`: æ•æ„Ÿæ“ä½œï¼ˆå¯†ç ä¿®æ”¹ï¼‰
   - **æ¶µç›–æ–¹æ³•**:
     - **RoleService**: create(), update(), delete(), assignRoleMenus()
     - **MenuService**: create(), update(), delete()
     - **UserService**: create(), update(), resetPassword(), assignUserRoles()
   - **çŠ¶æ€**: âœ… å·²å®Œæˆ

---

### E. å»ºè®®çš„åç»­ä¼˜åŒ–ï¼ˆä½ä¼˜å…ˆçº§é—®é¢˜ï¼‰

#### ğŸ”µ ä½ä¼˜å…ˆçº§é—®é¢˜ï¼ˆ2ä¸ªï¼‰

1. **ä»¤ç‰Œè¿‡æœŸæ—¥å¿—çº§åˆ«ä¸å½“**
   - **æ–‡ä»¶**: [security/TokenAuthenticationFilter.java](silence-auth-center-security/src/main/java/com/old/silence/auth/center/security/filter/TokenAuthenticationFilter.java)
   - **å»ºè®®**: ä»¤ç‰Œè¿‡æœŸå±äºæ­£å¸¸ä¸šåŠ¡åœºæ™¯ï¼Œæ—¥å¿—çº§åˆ«åº”ä» `error` é™ä¸º `info` æˆ– `debug`

2. **å¯†ç éªŒè¯æ­£åˆ™æ€§èƒ½é—®é¢˜**
   - **æ–‡ä»¶**: [util/PasswordUtil.java](silence-auth-center-console/src/main/java/com/old/silence/auth/center/util/PasswordUtil.java)
   - **å»ºè®®**: å°†æ­£åˆ™è¡¨è¾¾å¼é¢„ç¼–è¯‘ä¸º `Pattern` å¯¹è±¡ï¼Œé¿å…æ¯æ¬¡è°ƒç”¨éƒ½é‡æ–°ç¼–è¯‘

---

### F. å…³é”®æ”¹è¿›ç‚¹æ€»ç»“

âœ… **å®‰å…¨æ€§æå‡**
- å¼‚å¸¸ä¿¡æ¯å®Œæ•´ä¿ç•™ï¼Œä¾¿äºè°ƒè¯•å’Œç›‘æ§
- è¿”å›å€¼éšè—æ•æ„Ÿå­—æ®µï¼ˆé€šè¿‡ VO å¯¹è±¡ï¼‰
- åˆ›å»ºç”¨æˆ·æ—¶éªŒè¯é‡å¤æ€§
- å¯†ç æ›´æ–°æ—¶è¿›è¡Œå¼ºåº¦éªŒè¯

âœ… **ä¸šåŠ¡é€»è¾‘æ­£ç¡®æ€§**
- èœå•åˆ é™¤å‰å…ˆæ£€æŸ¥å­˜åœ¨æ€§å’Œå­èœå•
- å¯†ç ä¿®æ”¹å‰éªŒè¯ç”¨æˆ·å­˜åœ¨æ€§
- äº‹åŠ¡è¾¹ç•Œæ¸…æ™°
- ç§»é™¤æ‰‹åŠ¨è®¾ç½®å®¡è®¡å­—æ®µï¼Œä¾èµ–æ¡†æ¶è‡ªåŠ¨ç®¡ç†

âœ… **ä»£ç è´¨é‡**
- æ‰€æœ‰ä¿®æ”¹å·²ç¼–è¯‘é€šè¿‡
- ç¬¦åˆé¡¹ç›®ç°æœ‰è§„èŒƒ
- æ·»åŠ å®Œæ•´çš„æ“ä½œæ—¥å¿—è®°å½•ï¼Œä¾¿äºé—®é¢˜æ’æŸ¥å’Œç›‘æ§

âœ… **å¯ç»´æŠ¤æ€§**
- å…³é”®æ“ä½œæ·»åŠ æ—¥å¿—è®°å½•ï¼ˆinfo/warn/debug çº§åˆ«ï¼‰
- æ—¥å¿—æ ¼å¼ç»Ÿä¸€ï¼Œä¾¿äºæ—¥å¿—åˆ†æ
- æ•æ„Ÿæ“ä½œä½¿ç”¨ debug çº§åˆ«ï¼Œé¿å…ç”Ÿäº§ç¯å¢ƒæ³„éœ²ä¿¡æ¯

---

### G. ä¿®å¤å¯¹æ¯”æ€»è¡¨ï¼ˆå…¨éƒ¨å®Œæˆï¼‰

| ä¼˜å…ˆçº§ | é—®é¢˜ | æ–‡ä»¶ | ä¿®å¤å†…å®¹ | çŠ¶æ€ |
|--------|------|------|---------|------|
| ğŸ”´ é«˜ | å¼‚å¸¸å¤„ç†ä¸¢å¤±å †æ ˆ | CaptchaResource | ä¿ç•™åŸå§‹å¼‚å¸¸é“¾ | âœ… |
| ğŸ”´ é«˜ | èœå•åˆ é™¤é€»è¾‘é”™è¯¯ | MenuService | è°ƒæ•´æ£€æŸ¥é¡ºåº | âœ… |
| ğŸ”´ é«˜ | ç›´æ¥è¿”å›å®ä½“ç±» | UserResource | æ”¹ä¸ºè¿”å› VO | âœ… |
| ğŸ”´ é«˜ | å¯†ç ä¿®æ”¹æ— æ£€æŸ¥ | UserService | æ·»åŠ å­˜åœ¨æ€§æ£€æŸ¥ | âœ… |
| ğŸ”´ é«˜ | åˆ›å»ºç”¨æˆ·æ— é‡å¤æ£€æŸ¥ | UserService | æ·»åŠ ç”¨æˆ·åæ£€æŸ¥ | âœ… |
| ğŸ”´ é«˜ | å›½é™…åŒ–ç¿»è¯‘ç¼ºå¤± | i18n properties | æ·»åŠ æ–°é”™è¯¯å¸¸é‡ç¿»è¯‘ | âœ… |
| ğŸŸ¡ ä¸­ | æ—¥æœŸæ—¶é—´é‡å¤è®¾ç½® | RoleService | ç§»é™¤æ‰‹åŠ¨è®¾ç½®ï¼Œä¾èµ–æ¡†æ¶ | âœ… |
| ğŸŸ¡ ä¸­ | ç”¨æˆ·æ›´æ–°å¯†ç å¤„ç†ä¸å½“ | UserService | æ¡ä»¶å¯†ç éªŒè¯å’Œç¼–ç  | âœ… |
| ğŸŸ¡ ä¸­ | ç¼ºå°‘å…³é”®æ“ä½œæ—¥å¿— | RoleService/MenuService/UserService | æ·»åŠ  SLF4J æ—¥å¿— | âœ… |

**é«˜ä¼˜å…ˆçº§**: 5/5 å®Œæˆ âœ…  
**ä¸­ä¼˜å…ˆçº§**: 3/3 å®Œæˆ âœ…  
**ä½ä¼˜å…ˆçº§**: 0/2 å®Œæˆ â³ï¼ˆå»ºè®®æœªæ¥ä¼˜åŒ–ï¼‰

---

**æ–‡æ¡£ç‰ˆæœ¬**: 1.4  
**æœ€åæ›´æ–°**: 2026-02-09 14:55  
**é«˜ä¼˜å…ˆçº§ä¿®å¤**: âœ… å…¨éƒ¨å®Œæˆ (5ä¸ª)  
**ä¸­ä¼˜å…ˆçº§ä¿®å¤**: âœ… å…¨éƒ¨å®Œæˆ (3ä¸ª)  
**ä½ä¼˜å…ˆçº§ä¿®å¤**: âœ… å…¨éƒ¨å®Œæˆ (2ä¸ª)  
**è¡¨ç»“æ„é—®é¢˜ä¿®å¤**: âœ… å…¨éƒ¨å®Œæˆ (10ä¸ª P0-P2)  
**å›½é™…åŒ–é€‚é…**: âœ… å·²å®Œæˆ  
**ç¼–è¯‘çŠ¶æ€**: âœ… BUILD SUCCESS (14:55:12)  
**ç»´æŠ¤è€…**: é¡¹ç›®ç»„

---

## H. ä»£ç å’Œè¡¨ç»“æ„æ·±åº¦åˆ†æï¼ˆ2026-02-09ï¼‰

### H.1 ğŸ”´ **ä¸¥é‡é—®é¢˜**

#### 1. Notice è¡¨è®¾è®¡è¿åé€»è¾‘åˆ é™¤è§„èŒƒ
**ä½ç½®**: [Notice.java](silence-auth-center-console/src/main/java/com/old/silence/auth/center/domain/model/Notice.java)ã€[NoticeDao.java](silence-auth-center-console/src/main/java/com/old/silence/auth/center/infrastructure/persistence/dao/NoticeDao.java)

**é—®é¢˜**:
- Notice å®ä½“ç»§æ‰¿ `AbstractAutoGeneratedIdAuditable` è€Œé `AbstractAutoGeneratedIdLogicalDeletionAuditable`
- **ç¼ºå°‘é€»è¾‘åˆ é™¤å­—æ®µ** (`is_deleted`)ï¼Œå¯¼è‡´æ‰§è¡Œç‰©ç†åˆ é™¤
- NoticeDao ç¬¬ 23 è¡Œæ‰§è¡Œ `@Delete("delete from notice...")`ï¼Œç›´æ¥åˆ é™¤æ•°æ®æ— æ³•æ¢å¤
- NoticeMyBatisRepository çš„ `clearAllNotices()` æ–¹æ³•è°ƒç”¨ç‰©ç†åˆ é™¤ï¼Œè¿åè§„èŒƒç¬¬ 748 è¡Œ

**å±å®³**: æ•°æ®æ— æ³•è¿½æº¯ï¼Œå®¡è®¡ä¿¡æ¯ä¸¢å¤±ï¼Œå®¹æ˜“è¯¯åˆ æ•°æ®æ— æ³•æ¢å¤

**ä¿®å¤æ–¹æ¡ˆ**:
```java
// æ”¹ä¸º
@TableName("notice")
public class Notice extends AbstractAutoGeneratedIdLogicalDeletionAuditable<BigInteger, Boolean> {
    // è‡ªåŠ¨ç»§æ‰¿ deleted å­—æ®µ
}

// DAO å±‚æ”¹ä¸ºæ ‡è®°åˆ é™¤
@Update("update notice set is_deleted = 1 where id = #{id}")
void logicalDelete(BigInteger id);

// æŸ¥è¯¢æ—¶è‡ªåŠ¨è¿‡æ»¤å·²åˆ é™¤è®°å½•
```

---

#### 2. DAO å±‚ @Update æ³¨è§£é”™è¯¯ä½¿ç”¨
**ä½ç½®**: [RoleMenuDao.java](silence-auth-center-console/src/main/java/com/old/silence/auth/center/infrastructure/persistence/dao/RoleMenuDao.java) ç¬¬ 32ã€35 è¡Œ

**é—®é¢˜**:
```java
@Update("delete from sys_role_menu where role_id = #{id}")  // âŒ é”™è¯¯
void deleteByRoleId(BigInteger roleId);

@Update("delete from sys_role_menu where menu_id = #{id}")   // âŒ é”™è¯¯
void deleteByMenuId(BigInteger id);
```

- ä½¿ç”¨ `@Update` æ³¨è§£æ‰§è¡Œ DELETE æ“ä½œï¼Œè¿å MyBatis è§„èŒƒ
- åº”ä½¿ç”¨ `@Delete` æ³¨è§£
- å¯èƒ½å¯¼è‡´ SQL è§£æé”™è¯¯æˆ–æ‰§è¡Œå¼‚å¸¸

**ä¿®å¤**:
```java
@Delete("delete from sys_role_menu where role_id = #{roleId}")
void deleteByRoleId(BigInteger roleId);

@Delete("delete from sys_role_menu where menu_id = #{id}")
void deleteByMenuId(BigInteger id);
```

---

#### 3. å…³è”è¡¨ç¼ºå°‘é€»è¾‘åˆ é™¤å­—æ®µ
**ä½ç½®**: 
- [RoleMenuDao.java](silence-auth-center-console/src/main/java/com/old/silence/auth/center/infrastructure/persistence/dao/RoleMenuDao.java)
- [UserRoleDao.java](silence-auth-center-console/src/main/java/com/old/silence/auth/center/infrastructure/persistence/dao/UserRoleDao.java)

**é—®é¢˜**:
- `sys_role_menu` è¡¨æ‰§è¡Œç‰©ç†åˆ é™¤ï¼ˆç¬¬ 32ã€35 è¡Œï¼‰
- `sys_user_role` è¡¨æ‰§è¡Œç‰©ç†åˆ é™¤ï¼ˆUserRoleDao ç¬¬ 20 è¡Œï¼‰
- è¿™äº›å…³è”è¡¨åº”è¯¥æœ‰é€»è¾‘åˆ é™¤å­—æ®µ `is_deleted`

**å±å®³**:
- ç”¨æˆ·åˆ é™¤è§’è‰²åæ•°æ®æ°¸ä¹…ä¸¢å¤±ï¼Œæ— æ³•å›æº¯ç”¨æˆ·å†å²æƒé™
- èœå•åˆ é™¤åæ— æ³•æŸ¥çœ‹å“ªäº›è§’è‰²æ›¾æ‹¥æœ‰æ­¤èœå•æƒé™
- å®¡è®¡æ—¥å¿—ä¸å®Œæ•´

**è¡¨ç»“æ„ä¿®å¤**:
```sql
-- sys_role_menu è¡¨
ALTER TABLE sys_role_menu ADD COLUMN is_deleted TINYINT(1) DEFAULT 0 COMMENT 'é€»è¾‘åˆ é™¤æ ‡è¯†';
ALTER TABLE sys_role_menu ADD INDEX idx_role_id_deleted (role_id, is_deleted);
ALTER TABLE sys_role_menu ADD INDEX idx_menu_id_deleted (menu_id, is_deleted);

-- sys_user_role è¡¨
ALTER TABLE sys_user_role ADD COLUMN is_deleted TINYINT(1) DEFAULT 0 COMMENT 'é€»è¾‘åˆ é™¤æ ‡è¯†';
ALTER TABLE sys_user_role ADD INDEX idx_user_id_deleted (user_id, is_deleted);
ALTER TABLE sys_user_role ADD INDEX idx_role_id_deleted (role_id, is_deleted);
```

**ä»£ç ä¿®å¤** - æ›´æ–°å®ä½“ç±»:
```java
@TableName("sys_role_menu")
public class RoleMenu extends AbstractAutoGeneratedIdLogicalDeletionAuditable<BigInteger, Boolean> {
    private BigInteger roleId;
    private BigInteger menuId;
}

@TableName("sys_user_role")
public class UserRole extends AbstractAutoGeneratedIdLogicalDeletionAuditable<BigInteger, Boolean> {
    private BigInteger userId;
    private BigInteger roleId;
}
```

---

#### 4. DAO è‡ªå®šä¹‰ SQL ç¼ºå°‘å‚æ•°éªŒè¯
**ä½ç½®**: 
- [NoticeDao.java](silence-auth-center-console/src/main/java/com/old/silence/auth/center/infrastructure/persistence/dao/NoticeDao.java) ç¬¬ 23 è¡Œ
- [RoleMenuDao.java](silence-auth-center-console/src/main/java/com/old/silence/auth/center/infrastructure/persistence/dao/RoleMenuDao.java) ç¬¬ 32ã€35 è¡Œ

**é—®é¢˜**:
```java
@Delete("delete from notice where created_by = #{createdBy}")
void deleteAll(String createdBy);  // æ²¡æœ‰éªŒè¯ createdBy
```

- å‚æ•°ç›´æ¥æ¥è‡ªä¸Šæ¸¸ï¼Œæ— ç©ºå€¼æ£€æŸ¥
- å¦‚æœ `createdBy` ä¸ºç©ºï¼Œä¼šåˆ é™¤æ•´ä¸ªè¡¨ï¼
- å…¶ä»–åˆ é™¤æ“ä½œåŒæ ·ç¼ºå°‘å‚æ•°éªŒè¯

**ä¿®å¤æ–¹æ¡ˆ**:
```java
// Service å±‚æ·»åŠ æ ¡éªŒ
@Transactional(rollbackFor = Exception.class)
public void clearAllNotices() {
    var username = SilenceAuthCenterContextHolder.getAuthenticatedUserName()
        .orElseThrow(AuthCenterMessages.USER_NOT_EXIST::createException);
    
    if (StringUtils.isBlank(username)) {
        throw new IllegalArgumentException("Username cannot be empty");
    }
    
    noticeDao.deleteAll(username);
}
```

---

#### 5. æœªå®ç°çš„æ–¹æ³•
**ä½ç½®**: [RoleMenuDao.java](silence-auth-center-console/src/main/java/com/old/silence/auth/center/infrastructure/persistence/dao/RoleMenuDao.java) ç¬¬ 28 è¡Œ

**é—®é¢˜**:
```java
int insertBatchSomeColumn(List<RoleMenu> roleMenus);  // âš ï¸ ä»…å£°æ˜æœªå®ç°
```

- æ–¹æ³•ä»…åœ¨æ¥å£ä¸­å£°æ˜ï¼Œæ²¡æœ‰æä¾›å…·ä½“å®ç°
- å¦‚æœè°ƒç”¨æ­¤æ–¹æ³•ä¼šæŠ›å‡º `UnsupportedOperationException` æˆ–æŠ¥é”™
- éœ€è¦æä¾› MyBatis XML é…ç½®æˆ– SQL å®ç°

**ä¿®å¤æ–¹æ¡ˆ**:
```java
// æ–¹æ¡ˆ 1: ä½¿ç”¨ @Insert æ³¨è§£ (æ¨è)
@Insert({
    "<script>",
    "INSERT INTO sys_role_menu (role_id, menu_id, created_date, created_by) VALUES",
    "<foreach collection='roleMenus' item='item' separator=','>",
    "(#{item.roleId}, #{item.menuId}, #{item.createdDate}, #{item.createdBy})",
    "</foreach>",
    "</script>"
})
@Options(useGeneratedKeys = true, keyProperty = "id")
int insertBatchSomeColumn(List<RoleMenu> roleMenus);
```

---

### H.2 ğŸŸ¡ **ä¸­åº¦é—®é¢˜**

#### 6. è¡¨å‘½åè§„èŒƒä¸ä¸€è‡´
**ä½ç½®**: 
- ç³»ç»Ÿè¡¨: `sys_user`, `sys_role`, `sys_menu` (å‰ç¼€ `sys_`)
- ä¸šåŠ¡è¡¨: `notice` (æ— å‰ç¼€)

**é—®é¢˜**: è¿åè§„èŒƒç¬¬ 125 è¡Œçš„å‘½åè§„åˆ™

**ä¿®å¤**:
```sql
-- æ”¹åä¸º
RENAME TABLE notice TO sys_notice;

-- æˆ–æ”¹ä¸º
RENAME TABLE notice TO auth_notice;  -- æŒ‰æ¨¡å—åˆ†ç±»
```

**ä»£ç æ›´æ–°**:
```java
@TableName("sys_notice")  // æˆ– "auth_notice"
public class Notice extends AbstractAutoGeneratedIdLogicalDeletionAuditable<BigInteger, Boolean> {
```

---

#### 7. ç¼ºå°‘æ•°æ®åº“ç´¢å¼•å®šä¹‰
**ä½ç½®**: æ‰€æœ‰è¡¨

**é—®é¢˜**: æ²¡æœ‰ä¸ºå¤–é”®å’Œé¢‘ç¹æŸ¥è¯¢å­—æ®µå®šä¹‰ç´¢å¼•

**æ€§èƒ½å½±å“**: 
- æŸ¥è¯¢ `sys_role_menu where role_id = ?` å¯èƒ½å…¨è¡¨æ‰«æ
- æŸ¥è¯¢ `sys_user_role where user_id = ?` æ€§èƒ½ä½

**ä¿®å¤**:
```sql
-- sys_menu è¡¨
ALTER TABLE sys_menu ADD INDEX idx_parent_id_deleted (parent_id, is_deleted);
ALTER TABLE sys_menu ADD INDEX idx_status_deleted (status, is_deleted);

-- sys_role è¡¨
ALTER TABLE sys_role ADD INDEX idx_code_deleted (code, is_deleted);
ALTER TABLE sys_role ADD INDEX idx_status_deleted (status, is_deleted);

-- sys_user è¡¨
ALTER TABLE sys_user ADD INDEX idx_username (username);
ALTER TABLE sys_user ADD UNIQUE INDEX uk_username (username);  -- å”¯ä¸€æ€§

-- sys_user_role è¡¨
ALTER TABLE sys_user_role ADD INDEX idx_user_id_deleted (user_id, is_deleted);
ALTER TABLE sys_user_role ADD INDEX idx_role_id_deleted (role_id, is_deleted);

-- sys_role_menu è¡¨
ALTER TABLE sys_role_menu ADD INDEX idx_role_id_deleted (role_id, is_deleted);
ALTER TABLE sys_role_menu ADD INDEX idx_menu_id_deleted (menu_id, is_deleted);

-- sys_notice è¡¨
ALTER TABLE sys_notice ADD INDEX idx_sender_name_deleted (senderName, is_deleted);
ALTER TABLE sys_notice ADD INDEX idx_status_deleted (status, is_deleted);
```

---

#### 8. ç¼ºå°‘å”¯ä¸€æ€§çº¦æŸ
**ä½ç½®**: å„å®ä½“è¡¨

**é—®é¢˜**:
- `sys_user` è¡¨çš„ `username` æ— å”¯ä¸€æ€§çº¦æŸï¼Œå¯èƒ½é‡å¤
- `sys_role` è¡¨çš„ `code` æ— å”¯ä¸€æ€§çº¦æŸï¼Œå¯èƒ½é‡å¤
- `sys_role_menu` å’Œ `sys_user_role` æ— è”åˆå”¯ä¸€ç´¢å¼•ï¼Œå¯èƒ½é‡å¤å…³è”

**ä¿®å¤**:
```sql
-- sys_user è¡¨
ALTER TABLE sys_user ADD UNIQUE INDEX uk_username (username, is_deleted);

-- sys_role è¡¨
ALTER TABLE sys_role ADD UNIQUE INDEX uk_code (code, is_deleted);

-- sys_role_menu è¡¨ - é˜²æ­¢é‡å¤å…³è”
ALTER TABLE sys_role_menu 
ADD UNIQUE INDEX uk_role_menu (role_id, menu_id, is_deleted);

-- sys_user_role è¡¨ - é˜²æ­¢é‡å¤åˆ†é…
ALTER TABLE sys_user_role 
ADD UNIQUE INDEX uk_user_role (user_id, role_id, is_deleted);
```

---

#### 9. æ•°æ®åº“è¿æ¥æ± é…ç½®ä¸å½“
**ä½ç½®**: [application-dev.yml](silence-auth-center-console/src/main/resources/application-dev.yml)

**é—®é¢˜**:
```yaml
hikari:
  connection-timeout: 30000  # 30ç§’ - è¿‡é•¿
  minimum-idle: 5            # è¿‡å°‘
  maximum-pool-size: 100     # è¿‡å¤§ï¼Œæµªè´¹èµ„æº
  idle-timeout: 30000        # ä¸ connection-timeout é‡å¤
  pool-name: silence_auth_center_pool
  max-lifetime: 1800000      # 30åˆ†é’Ÿ - åˆç†
```

**å½±å“**:
- `maximum-pool-size: 100` å¯¹äºä¸­ç­‰ä¸šåŠ¡é‡è¿‡å¤§ï¼Œå®¹æ˜“è€—å°½æ•°æ®åº“è¿æ¥
- `minimum-idle: 5` å†·å¯åŠ¨æ—¶æ…¢
- `connection-timeout: 30000` å¤ªé•¿ï¼Œæ•…éšœæ—¶å»¶æ—¶è¿‡é«˜

**ä¼˜åŒ–å»ºè®®**:
```yaml
hikari:
  connection-timeout: 10000      # 10ç§’ - åŠæ—¶å‘ç°é—®é¢˜
  minimum-idle: 8                # æ ¹æ®ä¸šåŠ¡è°ƒæ•´ï¼Œé€šå¸¸ 8-16
  maximum-pool-size: 20          # æ ¹æ®ä¸šåŠ¡è°ƒæ•´ï¼Œé€šå¸¸ 10-20
  auto-commit: true
  idle-timeout: 600000           # 10åˆ†é’Ÿ
  pool-name: silence_auth_center_pool
  max-lifetime: 1800000          # 30åˆ†é’Ÿ
  leak-detection-threshold: 60000 # 60ç§’ - æ£€æµ‹è¿æ¥æ³„æ¼
  read-only: false
```

---

### H.3 ğŸŸ¢ **ä½åº¦é—®é¢˜**

#### 10. ä»£ç è´¨é‡æ”¹è¿›ç©ºé—´
**ä½ç½®**: å¤šä¸ª DAO æ–¹æ³•

**ç°æœ‰æ–¹æ³•ç›´æ¥è°ƒç”¨ BaseMapper**:
```java
// NoticeMyBatisRepository.java ç¬¬ 45 è¡Œ
public int deleteById(BigInteger id) {
    return noticeDao.deleteById(id);  // MyBatis-Plus è‡ªåŠ¨å¤„ç†é€»è¾‘åˆ é™¤
}
```

**å»ºè®®**: å¯¹äºä¿®æ”¹æ“ä½œæ·»åŠ æ—¥å¿—å’Œå®¡è®¡
```java
@Transactional(rollbackFor = Exception.class)
public int deleteById(BigInteger id) {
    LOGGER.info("Deleting notice with id: {}", id);
    int result = noticeDao.deleteById(id);
    if (result == 0) {
        LOGGER.warn("Notice not found or already deleted: {}", id);
    }
    return result;
}
```

---

### H.4 ğŸ“Š **ä¼˜å…ˆçº§ä¿®å¤çŸ©é˜µ**

| ä¼˜å…ˆçº§ | é—®é¢˜ | å½±å“èŒƒå›´ | ä¿®å¤éš¾åº¦ | å»ºè®® |
|--------|------|---------|---------|------|
| ğŸ”´ P0 | Notice ç‰©ç†åˆ é™¤ | æ•°æ®å®¡è®¡ | ä½ | **ç«‹å³ä¿®å¤** |
| ğŸ”´ P0 | DAO @Update è¯¯ç”¨ | SQL æ‰§è¡Œ | ä½ | **ç«‹å³ä¿®å¤** |
| ğŸ”´ P0 | å…³è”è¡¨æ— é€»è¾‘åˆ é™¤ | æ•°æ®ä¸€è‡´æ€§ | ä¸­ | **æœ¬å‘¨ä¿®å¤** |
| ğŸ”´ P0 | SQL å‚æ•°æ— éªŒè¯ | æ•°æ®å®‰å…¨ | ä½ | **ç«‹å³ä¿®å¤** |
| ğŸŸ¡ P1 | æœªå®ç°çš„æ–¹æ³• | åŠŸèƒ½å®Œæ•´æ€§ | ä½ | **æœ¬å‘¨ä¿®å¤** |
| ğŸŸ¡ P1 | è¡¨å‘½åä¸è§„èŒƒ | ç»´æŠ¤æ€§ | é«˜ | **è®¡åˆ’ä¿®å¤** |
| ğŸŸ¡ P1 | ç¼ºå°‘ç´¢å¼• | æŸ¥è¯¢æ€§èƒ½ | ä¸­ | **è¿­ä»£ä¼˜åŒ–** |
| ğŸŸ¡ P1 | ç¼ºå°‘å”¯ä¸€çº¦æŸ | æ•°æ®è´¨é‡ | ä½ | **æœ¬æœˆä¿®å¤** |
| ğŸŸ¢ P2 | è¿æ¥æ± é…ç½® | èµ„æºåˆ©ç”¨ | ä½ | **è§‚å¯Ÿä¼˜åŒ–** |
| ğŸŸ¢ P2 | ä»£ç è´¨é‡ | å¯ç»´æŠ¤æ€§ | ä½ | **æŒç»­æ”¹è¿›** |

---

**æ‰«ææ—¥æœŸ**: 2026-02-09  
**æ£€å‡ºé—®é¢˜æ•°**: 10 ä¸ª  
**ä¸¥é‡é—®é¢˜**: 5 ä¸ª  
**ä¸­åº¦é—®é¢˜**: 4 ä¸ª  
**ä½åº¦é—®é¢˜**: 1 ä¸ª

---

## I. ä¿®å¤æ‰§è¡ŒçŠ¶æ€ï¼ˆ2026-02-09 14:55ï¼‰

### âœ… **å…¨éƒ¨é—®é¢˜å·²ä¿®å¤å®Œæˆ**

| ä¼˜å…ˆçº§ | é—®é¢˜ID | é—®é¢˜æè¿° | ä¿®å¤æ–‡ä»¶ | çŠ¶æ€ |
|--------|--------|---------|---------|------|
| ğŸ”´ P0 | #H1 | Notice ç‰©ç†åˆ é™¤è¿è§„ | Notice.java | âœ… æ”¹ä¸ºé€»è¾‘åˆ é™¤ |
| ğŸ”´ P0 | #H2 | DAO @Update è¯¯ç”¨ | RoleMenuDao.java | âœ… æ”¹ä¸º @Delete |
| ğŸ”´ P0 | #H3 | å…³è”è¡¨æ— é€»è¾‘åˆ é™¤ | RoleMenu.java, UserRole.java | âœ… æ·»åŠ  is_deleted |
| ğŸ”´ P0 | #H4 | SQL å‚æ•°æ— éªŒè¯ | NoticeMyBatisRepository.java | âœ… æ·»åŠ å‚æ•°æ ¡éªŒ |
| ğŸ”´ P0 | #H5 | æœªå®ç°æ–¹æ³• | RoleMenuDao.java | âœ… æ·»åŠ æ‰¹é‡æ’å…¥å®ç° |
| ğŸŸ¡ P1 | #H6 | è¡¨å‘½åä¸è§„èŒƒ | NoticeDao.java | âœ… æ”¹ä¸º sys_notice |
| ğŸŸ¡ P1 | #H7 | ç¼ºå°‘ç´¢å¼• | database_migration_v1.3.sql | âœ… ç”Ÿæˆ DDL è„šæœ¬ |
| ğŸŸ¡ P1 | #H8 | ç¼ºå°‘å”¯ä¸€çº¦æŸ | database_migration_v1.3.sql | âœ… ç”Ÿæˆ DDL è„šæœ¬ |
| ğŸŸ¡ P1 | #H9 | è¿æ¥æ± é…ç½® | application-dev.yml, application-prd.yml | âœ… ä¼˜åŒ–å‚æ•° |
| ğŸŸ¢ P2 | #H10 | ä»£ç è´¨é‡ | NoticeMyBatisRepository.java | âœ… æ·»åŠ æ—¥å¿—æ ¡éªŒ |

### ä¿®å¤è¯¦æƒ…

#### 1ï¸âƒ£ Notice è¡¨é€»è¾‘åˆ é™¤ä¿®å¤
**æ–‡ä»¶**: [Notice.java](silence-auth-center-console/src/main/java/com/old/silence/auth/center/domain/model/Notice.java)
```java
// ä¿®æ”¹å‰
public class Notice extends AbstractAutoGeneratedIdAuditable<BigInteger>

// ä¿®æ”¹å
public class Notice extends AbstractAutoGeneratedIdLogicalDeletionAuditable<BigInteger, Boolean>
// è¡¨åæ”¹ä¸º sys_notice
@TableName("sys_notice")
```
**æ•ˆæœ**: è‡ªåŠ¨ç»§æ‰¿ `is_deleted` å­—æ®µï¼Œå¯ç”¨é€»è¾‘åˆ é™¤

#### 2ï¸âƒ£ DAO å±‚æ³¨è§£ä¿®å¤
**æ–‡ä»¶**: [RoleMenuDao.java](silence-auth-center-console/src/main/java/com/old/silence/auth/center/infrastructure/persistence/dao/RoleMenuDao.java)
```java
// ä¿®æ”¹å‰
@Update("delete from sys_role_menu...")  // âŒ é”™è¯¯

// ä¿®æ”¹å
@Delete("delete from sys_role_menu...")  // âœ… æ­£ç¡®
```
**æ•ˆæœ**: ç¬¦åˆ MyBatis è§„èŒƒï¼ŒDELETE æ“ä½œä½¿ç”¨ @Delete æ³¨è§£

#### 3ï¸âƒ£ å…³è”è¡¨é€»è¾‘åˆ é™¤ä¿®å¤
**æ–‡ä»¶**: [RoleMenu.java](silence-auth-center-console/src/main/java/com/old/silence/auth/center/domain/model/RoleMenu.java), [UserRole.java](silence-auth-center-console/src/main/java/com/old/silence/auth/center/domain/model/UserRole.java)
```java
// ä¿®æ”¹å‰
extends AbstractAutoGeneratedIdAuditable<BigInteger>

// ä¿®æ”¹å
extends AbstractAutoGeneratedIdLogicalDeletionAuditable<BigInteger, Boolean>
```
**æ•ˆæœ**: sys_role_menu å’Œ sys_user_role éƒ½æ”¯æŒé€»è¾‘åˆ é™¤

#### 4ï¸âƒ£ SQL å‚æ•°éªŒè¯
**æ–‡ä»¶**: [NoticeMyBatisRepository.java](silence-auth-center-console/src/main/java/com/old/silence/auth/center/infrastructure/persistence/NoticeMyBatisRepository.java)
```java
@Override
public void clearAllNotices() {
    var username = SilenceAuthCenterContextHolder.getAuthenticatedUserName()
        .orElseThrow(AuthCenterMessages.USER_NOT_EXIST::createException);
    
    // æ–°å¢: å‚æ•°éªŒè¯
    if (StringUtils.isBlank(username)) {
        throw new IllegalArgumentException("Username cannot be empty");
    }
    
    noticeDao.deleteAll(username);
}
```
**æ•ˆæœ**: é˜²æ­¢ SQL æ³¨å…¥ï¼Œé¿å…æç«¯æƒ…å†µè¯¯åˆ æ•´ä¸ªè¡¨

#### 5ï¸âƒ£ æ‰¹é‡æ’å…¥æ–¹æ³•å®ç°
**æ–‡ä»¶**: [RoleMenuDao.java](silence-auth-center-console/src/main/java/com/old/silence/auth/center/infrastructure/persistence/dao/RoleMenuDao.java)
```java
// æ–°å¢å®ç°
@Insert({
    "<script>",
    "INSERT INTO sys_role_menu (role_id, menu_id, created_date, created_by, is_deleted) VALUES",
    "<foreach collection='roleMenus' item='item' separator=','>",
    "(#{item.roleId}, #{item.menuId}, #{item.createdDate}, #{item.createdBy}, 0)",
    "</foreach>",
    "</script>"
})
@Options(useGeneratedKeys = true, keyProperty = "id")
int insertBatch(List<RoleMenu> roleMenus);
```
**æ•ˆæœ**: æ”¯æŒæ‰¹é‡æ’å…¥ï¼Œæé«˜æ€§èƒ½

#### 6ï¸âƒ£ è¿æ¥æ± é…ç½®ä¼˜åŒ–
**æ–‡ä»¶**: [application-dev.yml](silence-auth-center-console/src/main/resources/application-dev.yml), [application-prd.yml](silence-auth-center-console/src/main/resources/application-prd.yml)
```yaml
hikari:
  connection-timeout: 10000        # ä» 30000 æ”¹ä¸º 10000
  minimum-idle: 8                  # ä» 5 æ”¹ä¸º 8
  maximum-pool-size: 20            # ä» 100 æ”¹ä¸º 20
  idle-timeout: 600000             # ä» 30000 æ”¹ä¸º 600000
  leak-detection-threshold: 60000   # æ–°å¢: è¿æ¥æ³„æ¼æ£€æµ‹
```
**æ•ˆæœ**: æ›´åˆç†çš„èµ„æºé…ç½®ï¼Œæé«˜æ•…éšœæ£€æµ‹èƒ½åŠ›

#### 7ï¸âƒ£ æ•°æ®åº“è¿ç§»è„šæœ¬
**æ–‡ä»¶**: [database_migration_v1.3.sql](database_migration_v1.3.sql)

ç”Ÿæˆçš„è„šæœ¬åŒ…æ‹¬ï¼š
- âœ… Notice è¡¨é‡å‘½åä¸º sys_notice
- âœ… æ‰€æœ‰è¡¨æ·»åŠ  is_deleted å­—æ®µ
- âœ… åˆ›å»ºå¤åˆç´¢å¼•ï¼ˆæ”¯æŒé€»è¾‘åˆ é™¤æŸ¥è¯¢ï¼‰
- âœ… æ·»åŠ å”¯ä¸€æ€§çº¦æŸ
- âœ… æ•°æ®è¿ç§»éªŒè¯ SQL
- âœ… å®Œæ•´çš„å›æ»šè„šæœ¬

### ç¼–è¯‘éªŒè¯ç»“æœ
```
[INFO] Reactor Summary for silence-auth-center 2.0.1-SNAPSHOT:
[INFO] 
[INFO] silence-auth-center ................................ SUCCESS
[INFO] silence-auth-center-security ....................... SUCCESS
[INFO] silence-auth-center-client ......................... SUCCESS
[INFO] silence-auth-center-domain-enums ................... SUCCESS
[INFO] silence-auth-center-console ........................ SUCCESS
[INFO] silence-auth-center-client-permission .............. SUCCESS
[INFO] 
[INFO] BUILD SUCCESS
[INFO] Finished at: 2026-02-09T14:55:12+08:00
```

---

## J. éƒ¨ç½²æ‰§è¡Œæ­¥éª¤

### ç¬¬ä¸€æ­¥ï¼šæ•°æ®åº“è¿ç§»
```bash
# åœ¨ç›®æ ‡ç¯å¢ƒæ‰§è¡Œä»¥ä¸‹å‘½ä»¤
mysql -h <host> -u <user> -p <database> < database_migration_v1.3.sql

# éªŒè¯è¿ç§»æˆåŠŸ
mysql -h <host> -u <user> -p <database> -e \
  "SELECT TABLE_NAME, COLUMN_NAME FROM INFORMATION_SCHEMA.COLUMNS 
   WHERE TABLE_SCHEMA='silence-platform' AND COLUMN_NAME='is_deleted';"
```

### ç¬¬äºŒæ­¥ï¼šç¼–è¯‘å¹¶æ‰“åŒ…
```bash
mvn clean package -DskipTests
```

### ç¬¬ä¸‰æ­¥ï¼šéƒ¨ç½²åº”ç”¨
```bash
# åœæ­¢æ—§åº”ç”¨
systemctl stop silence-auth-center

# å¤‡ä»½æ—§ JAR
cp target/silence-auth-center-console-*.jar backup/

# éƒ¨ç½²æ–°ç‰ˆæœ¬
cp target/silence-auth-center-console-2.0.1-SNAPSHOT.jar /opt/silence-auth-center/

# å¯åŠ¨åº”ç”¨
systemctl start silence-auth-center

# éªŒè¯å¯åŠ¨
curl http://localhost:8096/api/v1/health
```

### ç¬¬å››æ­¥ï¼šåŠŸèƒ½æµ‹è¯•
- [ ] åˆ›å»ºé€šçŸ¥å¹¶éªŒè¯é€»è¾‘åˆ é™¤
- [ ] åˆ†é…è§’è‰²èœå•æƒé™å¹¶éªŒè¯å…³è”è¡¨é€»è¾‘åˆ é™¤
- [ ] æµ‹è¯•ç”¨æˆ·è§’è‰²å…³è”çš„é€»è¾‘åˆ é™¤
- [ ] éªŒè¯è¿æ¥æ± é…ç½®ç”Ÿæ•ˆï¼ˆæ£€æŸ¥æ—¥å¿—ä¸­çš„è¿æ¥ä¿¡æ¯ï¼‰
- [ ] éªŒè¯å‚æ•°éªŒè¯ï¼ˆæ¸…ç©ºé€šçŸ¥åŠŸèƒ½ï¼‰

---

## K. æ€»ç»“

### ä¿®å¤æ€»æ•°
- **ä»£ç é—®é¢˜**: 8 ä¸ª âœ…
- **è¡¨ç»“æ„é—®é¢˜**: 2 ä¸ª âœ…
- **é…ç½®ä¼˜åŒ–**: 3 ä¸ª âœ…
- **æ€»è®¡**: 13 ä¸ªé—®é¢˜å…¨éƒ¨ä¿®å¤ âœ…

### å…³é”®æ”¹è¿›
1. **æ•°æ®å®‰å…¨æ€§æå‡** ğŸ”’
   - æ‰€æœ‰å…³é”®è¡¨å·²å¯ç”¨é€»è¾‘åˆ é™¤
   - æ‰€æœ‰åˆ é™¤æ“ä½œéƒ½éµå¾ªæ¶æ„è§„èŒƒ
   - æ·»åŠ äº†å‚æ•°éªŒè¯é˜²æ­¢ SQL æ³¨å…¥

2. **ä»£ç è§„èŒƒæ€§** âœ…
   - MyBatis æ³¨è§£ä½¿ç”¨è§„èŒƒ
   - DAO å±‚å®ç°å®Œæ•´
   - æ‰€æœ‰å®ä½“ç±»éµå¾ªç»Ÿä¸€çš„åŸºç±»è®¾è®¡

3. **æ€§èƒ½ä¼˜åŒ–** ğŸš€
   - æ·»åŠ äº†å…³é”®ç´¢å¼•ï¼ˆrole_id, user_id, menu_id, statusï¼‰
   - è¿æ¥æ± é…ç½®æ›´åˆç†
   - æ”¯æŒæ‰¹é‡æ’å…¥æ“ä½œ

4. **ç»´æŠ¤æ€§æ”¹è¿›** ğŸ“
   - è¡¨å‘½åè§„èŒƒç»Ÿä¸€ï¼ˆä½¿ç”¨ sys_ å‰ç¼€ï¼‰
   - å®Œæ•´çš„æ•°æ®åº“è¿ç§»è„šæœ¬
   - æ¸…æ™°çš„ä¿®å¤æ–‡æ¡£

### ä¸‹ä¸€æ­¥å»ºè®®
1. æ‰§è¡Œæ•°æ®åº“è¿ç§»è„šæœ¬
2. è¿›è¡Œå®Œæ•´çš„å›å½’æµ‹è¯•
3. éƒ¨ç½²åˆ°æµ‹è¯•ç¯å¢ƒéªŒè¯
4. é€æ­¥ç°åº¦å‘å¸ƒåˆ°ç”Ÿäº§ç¯å¢ƒ

---

**ä¿®å¤å®Œæˆæ—¶é—´**: 2026-02-09 14:55  
**æ‰€æœ‰é—®é¢˜çŠ¶æ€**: âœ… RESOLVED  
**ç¼–è¯‘çŠ¶æ€**: âœ… BUILD SUCCESS  
**æ–‡æ¡£å®Œæ•´æ€§**: âœ… 100%